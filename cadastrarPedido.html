<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar pedido</title>
    <script src="Js/jquery.min.js"></script> <!-- Conexão com Jquery (externo) -->
    <script src="Js/script.js"></script> <!-- Conexão com JavaScript (externo) -->
    <script>
        // Declarando o Banco de Dados (Lanchonete)
        var db = window.openDatabase("Lanchonete", "2.0", "Mybase", 4048);
        /* Criando a Tabela Produtos (armazena os produtos cadastrados) 
        e a Tabela Usuarios (armazena os usuários cadastrados) */
        db.transaction(function(criar){
            criar.executeSql('CREATE TABLE Produtos(CodID INTEGER PRIMARY KEY, nomeProd TEXT, valorProd Real, tipoProd TEXT)');
        });

        // Função para exibir os Lanches existentes
        function exibirLanches(){
            i = 0;
            /* Declarando um Array e realizando um laço de repetição (for) para exibir os
            registros do Banco de Dados onde "tipoProd" seja igual a "Lanche" */
            dadosDoBanco = [];
            db.transaction(function(tx){ 
                tx.executeSql('SELECT * FROM Produtos WHERE tipoProd = ?', ['Lanche'], function (tx, results) { 
                    len = results.rows.length, i;  
                    for (i = 0; i < len; i++) { 
                        row = results.rows.item(i);
                        dadosDoBanco = [
                            row['CodID'],
                            row['nomeProd'],
                            row['valorProd'],
                            row['tipoProd']
                        ];
                        document.getElementById('lista-lanches').innerHTML += dadosDoBanco[0] + " - " + dadosDoBanco[1] + " - " + dadosDoBanco[2] + "<br><button id='btn" + dadosDoBanco[0] + "' onclick='adicionar("+ dadosDoBanco[0] +")'>Adicionar</button><br><br>";
                    }
                }, null); 
            });
        }

        // Função para exibir as Bebidas existentes
        function exibirBebidas(){
            i = 0;
            dadosDoBanco = []; // Array para armazenar os dados dos produtos
            /* Declarando um laço de repetição (for) para exibir os
            registros do Banco de Dados onde "tipoProd" seja igual a "Bebida" */
            db.transaction(function(tx){ 
                tx.executeSql('SELECT * FROM Produtos WHERE tipoProd = ?', ['Bebida'], function (tx, results) { 
                    len = results.rows.length, i;  
                    for (i = 0; i < len; i++) { 
                        row = results.rows.item(i);
                        dadosDoBanco = [
                            row['CodID'],
                            row['nomeProd'],
                            row['valorProd'],
                            row['tipoProd']
                        ];
                        document.getElementById('lista-bebidas').innerHTML += dadosDoBanco[0] + " - " + dadosDoBanco[1] + " - " + dadosDoBanco[2] + "<br><button id='btn" + dadosDoBanco[0] + "' onclick='adicionar("+ dadosDoBanco[0] +")'>Adicionar</button><br><br>";
                    }
                }, null); 
            });
        }

        ArrCodsProds = []; // Array para armazenar os produtos que estiverem no "carrinho"
        // Função para adicionar um Produto específico ao "carrinho" (lista de pedidos)
        function adicionar(codProduto){
            i = 0;
            dadosDoProduto = []; // Array para armazenar os dados dos produtos
            ArrCodsProds.push(codProduto); // Adicionando um valor no Array "carrinho"
            txtString = document.getElementById('carrinho').innerHTML;
            /* Declarando um laço de repetição (for) para exibir o registro
            do Banco de Dados onde "CodID" seja igual ao parâmetro "codProduto" */
            db.transaction(function(tx){ 
                tx.executeSql('SELECT * FROM Produtos WHERE CodID = ?', [codProduto], function (tx, results) { 
                    len = results.rows.length, i;  
                    for (i = 0; i < len; i++) { 
                        row = results.rows.item(i);
                        dadosDoProduto = [
                            row['CodID'],
                            row['nomeProd'],
                            row['valorProd'],
                            row['tipoProd']
                        ];
                        
                        vlrDoProduto = dadosDoProduto[2].replace(',', '.');
                        vlrDoProduto = parseFloat(vlrDoProduto).toFixed(2);

                        document.getElementById('carrinho').innerHTML += "<p id='p"+ dadosDoProduto[0] +"'>" + dadosDoProduto[1] + " ("+ dadosDoProduto[3] +") - <button onclick='menos(" + dadosDoProduto[0] + "," + vlrDoProduto + ")'>-</button> <span id='qntd" + dadosDoProduto[0] + "'>1</span><button onclick='mais(" + dadosDoProduto[0] + "," + vlrDoProduto + ")'>+</button><br> R$ <span class='totalVlrs' id='total"+ dadosDoProduto[0] +"'>"+ dadosDoProduto[2] +" </span><button onclick='retirar(" + dadosDoProduto[0] + ")'> Remover </button></p>";

                        if(txtString.indexOf('btn'+codProduto) == -1){
                            document.getElementById('btn'+codProduto).removeAttribute("onclick");
                        }

                        $("#calcular").css("display","");
                    }
                }, null); 
            });
        }
   
        /* Função para adicionar +1 no valor da quantidade desejada de um Produto específico
        e exibir o resultado da multiplicação entre quantidade e valor do Produto */
        function mais(codProdutoAdd, nrVlrProdutoMais){
            // Adicionar +1 na quantidade
            var qntdAtual = document.getElementById('qntd'+codProdutoAdd).innerHTML;
            var vlrQntdAtual = parseInt(qntdAtual);
            vlrQntdAtual = vlrQntdAtual+1;
            document.getElementById('qntd'+codProdutoAdd).innerHTML = vlrQntdAtual;

            // Exibir o total (valor*quantidade)
            qntdTexto = document.getElementById('qntd'+codProdutoAdd).innerHTML;
            qntdTexto = parseFloat(qntdTexto);
            nrVlrProdutoMais = (nrVlrProdutoMais).toFixed(2);
            document.getElementById('total'+codProdutoAdd).innerHTML = (nrVlrProdutoMais*vlrQntdAtual).toFixed(2);
        }

        /* Função para subtrair -1 no valor da quantidade desejada de um Produto específico
        e exibir o resultado da multiplicação entre quantidade e valor do Produto */
        function menos(codProdutoSub, nrVlrProdutoMenos){
            // Subtrair -1 na quantidade
            var qntdAtual = document.getElementById('qntd'+codProdutoSub).innerHTML;
            var vlrQntdAtual = parseInt(qntdAtual);
            vlrQntdAtual = vlrQntdAtual-1;
            if(vlrQntdAtual < 1){
                vlrQntdAtual = 1;
            }
            document.getElementById('qntd'+codProdutoSub).innerHTML = vlrQntdAtual;

            // Exibir o total (valor*quantidade)
            qntdTexto = document.getElementById('qntd'+codProdutoSub).innerHTML;
            qntdTexto = parseFloat(qntdTexto);
            nrVlrProdutoMenos = (nrVlrProdutoMenos).toFixed(2);
            document.getElementById('total'+codProdutoSub).innerHTML = (nrVlrProdutoMenos*vlrQntdAtual).toFixed(2);
        }

        // Função para remover um Produto do "carrinho"
        function retirar(codRetirarProduto){
            ArrCodsProds.splice(ArrCodsProds.indexOf(codRetirarProduto), 1);

            document.getElementById('p'+codRetirarProduto).outerHTML = "";
            document.getElementById('btn'+codRetirarProduto).setAttribute('onclick','adicionar('+codRetirarProduto+')');
            if(document.getElementById('carrinho').innerHTML == ""){
                // Faz os elementos abaixo desaparecerem
                $("#calcular").css("display","none");
                $("#valor").css("display", "none");
            }
        }

        // Função para calcular o total da soma de todos valores existentes no "carrinho"
        function calcular(){
            // Faz o elemento abaixo aparecer
            $("#valor").css("display", "");

            total = 0;
            resultadosTotal = [];
            function somar(item){
                v = document.getElementById('total'+item).innerHTML;
                v = v.replace(',', '.');
                v = parseFloat(v).toFixed(2);
                resultadosTotal.push(v);
            }
            
            ArrCodsProds.forEach(somar);
            for(var i = 0; i < resultadosTotal.length; i++){
                total += Number(resultadosTotal[i]);
            }
            
            document.getElementById('total-valor').innerHTML = "R$" + total.toFixed(2);
        }

        // Função para finalizar o pedido
        function finalizar(){
            alert("Pedido confirmado com sucesso!");
            location.reload();
        }
    </script>
</head>
<body>
    <!-- Links para outras páginas deste projeto -->
    <a href="cadastrarPedido.html"><button>Fazer pedido</button></a> <!-- exibir dados do banco (produtos) e operações aritméticas (+, -, *, /), arrays -->
    <a href="cadastrarProduto.html"><button>Inserir produto</button></a> <!-- inserção de dados no banco -->
    <a href="editarProduto.html"><button>Editar produto</button></a> <!-- atualizar ou deletar dados do banco -->
    <a href="loginUsuario.html"><button>Login</button></a>
    
    <!-- Onde os dados serão exibidos -->
    <div id="dados">
        <h1>LANCHES:</h1>
        <p id="lista-lanches">
            <script>
                exibirLanches();
            </script>
        </p>

        <h1>BEBIDAS:</h1>
        <p id="lista-bebidas">
            <script>
                exibirBebidas();
            </script>
        </p>
    </div>
    <!-- Onde os dados serão exibidos -->
    <h1>PEDIDO:</h1>
    <div id="carrinho"></div>
    <button onclick="calcular()" style="display: none;" id="calcular">Calcular</button>
    <div id="valor" style="display: none;">
        <h1>TOTAL:</h1>
        <span id="total-valor"></span>
        <button onclick="finalizar()">Finalizar pedido</button>
    </div>
</body>
</html>